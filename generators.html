
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1. Methods, iterables, and generators for reading files &#8212; Analytics and Integrative Machine Learning</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Introduction" href="home.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/NCAR-contemp-logo-blue.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Analytics and Integrative Machine Learning</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="home.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   1. Methods, iterables, and generators for reading files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="#data-loaders-for-ml-pipelines">
   2. Data Loaders for ML Pipelines
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/generators.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/generators.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   1. Methods, iterables, and generators for reading files
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-python-method">
     The Python Method
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-python-generator">
     The Python Generator
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-python-iterable">
     The Python Iterable
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-even-have-generators-when-there-are-already-iterators">
     Why even have generators when there are already iterators?
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#when-should-i-use-a-generator-rather-than-a-method">
     When should I use a generator rather than a method?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loaders-for-ml-pipelines">
   2. Data Loaders for ML Pipelines
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-dataset-reader">
     The Dataset Reader
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-iterator">
     The Iterator
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#torch">
       Torch
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#keras">
       Keras
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tensorflow">
       Tensorflow
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="methods-iterables-and-generators-for-reading-files">
<h1>1. Methods, iterables, and generators for reading files<a class="headerlink" href="#methods-iterables-and-generators-for-reading-files" title="Permalink to this headline">¶</a></h1>
<p>We all need to open, close, and save data to files using Python. Loading a file always involves reading the lines in the file, and possibly doing some processing on each line. An example file <span class="math notranslate nohighlight">\(\textbf{test_data.txt}\)</span> contains 1,000,000 rows (lines) and 3 columns separated by an empty space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fn</span> <span class="o">=</span> <span class="s2">&quot;generators/test_data.txt&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-python-method">
<h2>The Python Method<a class="headerlink" href="#the-python-method" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">method_loader</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="c1"># Read in lines until reaching EOF</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span> <span class="c1"># Process each line</span>
    <span class="k">return</span> <span class="n">lines</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">processed_line</span> <span class="ow">in</span> <span class="n">method_loader</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
<p>The entire file was read into memory with the .readlines() call, before any line processing was performed.</p>
<p>Reading files like this shouldn’t be a problem for file sizes up to ~1G. But sometimes we have no choice and have to work with large files (sometimes hundreds of gigs). As a result the readlines operation can take a very long time. Furthermore, if the file is too large to load into memory, python will throw the <strong>MemoryError</strong> exception and your program will terminate <em>with error</em>.</p>
<p>We frequently encounter large datafiles at NCAR. What can we do about it?</p>
<p>Reading and processing one line at a time would solve this problem. We could even process an “infinitely” large file, which means any file that’s too large to load fully into memory.</p>
<p>This kind of file reading is called <strong>lazy</strong> reading.</p>
</div>
<div class="section" id="the-python-generator">
<h2>The Python Generator<a class="headerlink" href="#the-python-generator" title="Permalink to this headline">¶</a></h2>
<p>There is a special tool in the python toolbox that easily enables lazy reading called a generator. The generator object is built on top of python’s Iterator object class, but I will cover them in reverse below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generator_loader</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We’ve replaced the return with something new named <span class="math notranslate nohighlight">\(\color{green}{\textbf{yield}}\)</span>. This chunk of code looks similar to the method_loader!</p>
<p>Test it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">processed_line</span> <span class="ow">in</span> <span class="n">generator_loader</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">processed_line</span><span class="p">)</span>
    <span class="k">break</span> <span class="c1"># Stop early, I don&#39;t need to print 1,000,000 lines!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<p>It behaves similarly when in use as compared to the method variant presented above. The big difference is that the generator version is more memory efficient because, through <span class="math notranslate nohighlight">\(\color{green}{\textbf{yield}}\)</span>, lines are read into memory one at a time, returned, released, …, until reaching the end of the file (EOF).</p>
<p>That is to say <span class="math notranslate nohighlight">\(\color{green}{\textbf{yield}}\)</span> returns more than once, whereas <span class="math notranslate nohighlight">\(\color{green}{\textbf{return}}\)</span> in a method signals the end (in terms of memory usage, as it is freed and the method is exited).</p>
<p>Generators work nicely with serialized data … you may have <strong><em>dumped</em></strong> data using the pickle library before. The pickle library allows you to do that for the entire file, all in one go, or line-by-line as the example below illustrates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fn_pkl</span> <span class="o">=</span> <span class="s2">&quot;generators/test_data.pkl&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_to_pickle</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span> <span class="c1"># Iteration over .dump</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">write_to_pickle</span><span class="p">(</span>
    <span class="n">method_loader</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span>
    <span class="n">fn_pkl</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>From here will assume that we do not know how many lines are in our serialized data dump:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_from_pickle</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># Keep looping with while.</span>
            <span class="k">yield</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="c1"># Iteration over .load</span>
</pre></div>
</div>
</div>
</div>
<p>where the <span class="math notranslate nohighlight">\(\color{green}{\textbf{while True}}\)</span> clause will keep looping over the call to load pickled data until we reach the end of the file.</p>
<p>Test it!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">load_from_pickle</span><span class="p">(</span><span class="n">fn_pkl</span><span class="p">):</span>
    <span class="k">continue</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">EOFError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">23</span><span class="o">-</span><span class="mi">2</span><span class="n">de8c1965edf</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">load_from_pickle</span><span class="p">(</span><span class="n">fn_pkl</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">continue</span>

<span class="nn">&lt;ipython-input-22-45015fa1bf7e&gt;</span> in <span class="ni">load_from_pickle</span><span class="nt">(fn)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># Keep looping with while.</span>
<span class="ne">----&gt; </span><span class="mi">4</span>             <span class="k">yield</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="c1"># Iteration over .load</span>

<span class="ne">EOFError</span>: Ran out of input
</pre></div>
</div>
</div>
</div>
<p>It failed!</p>
<p>There must still be a signal that can be used to stop the geneartor from yielding the next line when it does not exist.</p>
<p>Note that the <em>exception</em> python threw was an <span class="math notranslate nohighlight">\(\color{red}{\textbf{EOFError}}\)</span> exception. We can catch that and use it to exit the generator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_from_pickle</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># We do not necessarily know how many lines are in fn</span>
                <span class="k">yield</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>               
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Do nothing and leave read_from_pickle without error </span>
</pre></div>
</div>
</div>
</div>
<p>Now it will run without error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">load_from_pickle</span><span class="p">(</span><span class="n">fn_pkl</span><span class="p">):</span>
    <span class="k">continue</span>
    
<span class="c1"># Finishes without error</span>
</pre></div>
</div>
</div>
</div>
<p>This is rather clunky! Now we have to do <em>exception handling</em> (gasp). You might be wondering what good are python generators at helping us to simplify memory usage when this style of coding makes the workflow more complex. We could have relied on python’s Iterator objects (covered next), to do lazy reading.</p>
<p>Fortunatly, python developers also included a generalized version of yield, <span class="math notranslate nohighlight">\(\color{green}{\textbf{yield from}}\)</span> for these siuations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_from_pickle</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">load_from_pickle</span><span class="p">(</span><span class="n">fn_pkl</span><span class="p">):</span>
    <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finishes without error. </span>
</pre></div>
</div>
</div>
</div>
<p>In short, generators allow us to write simple code that helps to simplfy memory usage when working with large data files.</p>
</div>
<div class="section" id="the-python-iterable">
<h2>The Python Iterable<a class="headerlink" href="#the-python-iterable" title="Permalink to this headline">¶</a></h2>
<p>Before generators were introduced, one relied on a python <strong>Iterator</strong> object to produce lazy readers. Iterable classes are not too difficult to write, but they have dependencies, in particular, they must contain the <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__iter__}}\)</span> and <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__next__}}\)</span> “thunder” methods.</p>
<p>A simple example with our serialized (pickled) data from above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">read_from_pickle_iterable</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
</pre></div>
</div>
</div>
</div>
<p>The thunder method <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__iter__}}\)</span> returns the object itself (through self!), while <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__next__}}\)</span> is used to return the result of the .load call on the opened file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rfpi</span> <span class="o">=</span> <span class="n">read_from_pickle_iterable</span><span class="p">(</span><span class="n">fn_pkl</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using the Iterator’s <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__next__}}\)</span> functionality, we then grab the lines from the file one-by-one without opening the entire file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">rfpi</span><span class="p">)</span> <span class="c1"># Use next like this</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">EOFError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-44-1e1bfab26979&gt;</span> in <span class="ni">__next__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">12</span>             <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>         <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>

<span class="ne">EOFError</span>: Ran out of input

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">51</span><span class="o">-</span><span class="n">d7c5bd59b55e</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="nb">next</span><span class="p">(</span><span class="n">rfpi</span><span class="p">)</span> <span class="c1"># Use next like this</span>

<span class="nn">&lt;ipython-input-44-1e1bfab26979&gt;</span> in <span class="ni">__next__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span>             <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>         <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">14</span>             <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="ne">StopIteration</span>: 
</pre></div>
</div>
</div>
</div>
<p>which dies as intended when the <span class="math notranslate nohighlight">\(\color{red}{\textbf{EOFError}}\)</span> caught and the <span class="math notranslate nohighlight">\(\color{red}{\textbf{StopException}}\)</span> exception was thrown using the <span class="math notranslate nohighlight">\(\color{green}{\textbf{raise}}\)</span> clause. When the iterator object is rolled out in a loop (or by list(), etc) it will exit without error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_from_pickle_iterable</span><span class="p">(</span><span class="n">fn_pkl</span><span class="p">):</span>
    <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="why-even-have-generators-when-there-are-already-iterators">
<h2>Why even have generators when there are already iterators?<a class="headerlink" href="#why-even-have-generators-when-there-are-already-iterators" title="Permalink to this headline">¶</a></h2>
<p>The answer is because generators are more compact and easier to write, as you do not have to explicitly sub-class them with the <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__iter__}}\)</span> and <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__next__}}\)</span>. That’s taken care of under-the-hood with the generator class. But the converse is not true: iterables do not have the yield capability.</p>
</div>
<div class="section" id="when-should-i-use-a-generator-rather-than-a-method">
<h2>When should I use a generator rather than a method?<a class="headerlink" href="#when-should-i-use-a-generator-rather-than-a-method" title="Permalink to this headline">¶</a></h2>
<p>There are lots of scenerios, in addition to data loading! Note that in the first method example above, a list was returned. Do you need all elements of the list, all at the same time? If the answer is no, then you want to try to use a generator if that file is large in size!</p>
<p>With generators one tries to balance the time spent performing operations with/on the data with memory utilization. Using them will often be determined by how your program is designed to run and utilize resources. If you are presented with a significant memory bottleneck, generators are very often the way to go. However if your program does not have said memory issue, using a generator might result in the program running significantly slower.</p>
<p>As you use generators more and more in your work-flow, you will learn to apply them when they are needed and when to avoid them when they do not offer any benefit over using methods.</p>
</div>
</div>
<div class="section" id="data-loaders-for-ml-pipelines">
<h1>2. Data Loaders for ML Pipelines<a class="headerlink" href="#data-loaders-for-ml-pipelines" title="Permalink to this headline">¶</a></h1>
<p>Next, let us combine methods, generators and iterators and build something a little more involved – how about effecient data objects for preparation and data ingestion into ML models?</p>
<p>We will look at the holodec data (as of Oct 12, 2020), which contains large hologram images and numerical data accompaning each image. The holodec data is saved as netCDF format – by default the data type only supports lazy reading!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">holodecml.data</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</div>
<p>The main method to load the data is reproduced here (which calls other methods, not shown)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_raw_datasets</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">output_cols</span><span class="p">,</span> <span class="n">subset</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">open_dataset</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subset</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subset</span> <span class="o">*</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">][:</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">output_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">output_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>    
    <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
</div>
<p>For most data files, there is nothing wrong with this method – its compact, easy to read, and does what you want it to do. As we have seen with the file loading example above, methods quickly become memory inefficient once files become large in size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">path_data</span> <span class="o">=</span> <span class="s2">&quot;/glade/p/cisl/aiml/ai4ess_hackathon/holodec/&quot;</span>
<span class="n">num_particles</span> <span class="o">=</span> <span class="s2">&quot;multi&quot;</span>
<span class="n">split</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>
<span class="n">subset</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">output_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;hid&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">load_raw_datasets</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">output_cols</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This file is pretty large, not large enough to cause a memory overflow, but it still takes about 5 minuites to load.</p>
<p>Let us first write a lazy reader that returns the same thing data as the above method, but one row at a time. Then we will utilize special iterable objects from the Torch, Tensorflow, and Keras libraries that will enable multiprocessing with multiple simultanous workers for creating batches as well as other transformations.</p>
<div class="section" id="the-dataset-reader">
<h2>The Dataset Reader<a class="headerlink" href="#the-dataset-reader" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
</div>
<p>Torch.utils.data.Dataset and tensorflow.keras.utils.Sequence objects both require a custom “Reader” class to contain the <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__len__}}\)</span> and <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__getitem__}}\)</span> thunder methods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HologramReader</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span> <span class="c1"># Sequence</span>
    
    <span class="s1">&#39;Generates data for Keras/Tensorflow/Torch environments&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">path_data</span><span class="p">,</span> 
                 <span class="n">num_particles</span><span class="p">,</span> 
                 <span class="n">split</span><span class="p">,</span> 
                 <span class="n">output_cols</span><span class="p">,</span> 
                 <span class="n">subset</span><span class="p">,</span> 
                 <span class="n">maxnum_particles</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        
        <span class="s1">&#39;Initialization&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">open_dataset</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output_cols</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;hid&#39;</span><span class="p">]</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">hologram_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">hologram_number</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxnum_particles</span> <span class="o">=</span> <span class="n">maxnum_particles</span>
        
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Denotes the number of batches per epoch&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hologram_numbers</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="s1">&#39;Return one row of data&#39;</span>
        
        <span class="c1"># Select one &quot;row&quot; from the dataset</span>
        <span class="n">hologram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hologram_numbers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][</span><span class="n">hologram</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxnum_particles</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxnum_particles</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> 
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_cols</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hologram</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particles</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_cols</span><span class="p">):</span>
                <span class="n">y_out</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_reader</span> <span class="o">=</span> <span class="n">HologramReader</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">output_cols</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The method <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__getitem__}}\)</span> is used to select whichever hologram we want (take the one labeled 0):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data_reader</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(600, 400) (100, 4)
</pre></div>
</div>
</div>
</div>
<p>Make a quick plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x2ac3cfa7f550&gt;
</pre></div>
</div>
<img alt="_images/generators_69_1.png" src="_images/generators_69_1.png" />
</div>
</div>
</div>
<div class="section" id="the-iterator">
<h2>The Iterator<a class="headerlink" href="#the-iterator" title="Permalink to this headline">¶</a></h2>
<div class="section" id="torch">
<h3>Torch<a class="headerlink" href="#torch" title="Permalink to this headline">¶</a></h3>
<p>To make the the torch/keras Reader class iterable, we can wrap a torch DataLoader object around it which will enable batching, multiprocessing capabilities, and other options. As noted, the DataLoader object requires that the Reader class contains the <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__len__}}\)</span> and <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__getitem__}}\)</span> thunder methods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_iterator</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">data_reader</span><span class="p">,</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data_iterator</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([32, 600, 400]) torch.Size([32, 100, 4])
</pre></div>
</div>
</div>
</div>
<p>The DataLoader object will take care of creating independent workers that each will load the Reader and put the row data onto a queue where the data is sent back to a Manager that feeds the model. The first few calls to data_iterator will be slow as the workers have to be initialized before they can start putting data onto a queue.</p>
<p>In a future blog post we will write our own multiprocessing worker class, but lets appreciate how easy the big three libraries have made it for us to get to this point.</p>
</div>
<div class="section" id="keras">
<h3>Keras<a class="headerlink" href="#keras" title="Permalink to this headline">¶</a></h3>
<p>When training a model with Keras, all we have to do is swap <span class="math notranslate nohighlight">\(\color{black}{\textbf{HologramReader(Dataset)}}\)</span> for <span class="math notranslate nohighlight">\(\color{black}{\textbf{HologramReader(Sequence)}}\)</span> and make no other changes. We also could have skipped using the inheritance approach and specify the output type (torch tensor versus numpy tensor) upon return.</p>
<p>In older Keras versions, the Reader would be fed into the Model.fit_generator method, which allowed one to toggle the number of workers and queue size. The important bit about the Sequence object is that it is thread-safe, meaning the workers spawned will not duplicate data chunks (this isn’t necessarily always a problem but depends on the type of data being used).</p>
<p>The torch DataLoader came with shuffle capability (by initializing a random order using the <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__len__}}\)</span> method), whereas in the Sequence object, shuffle functionality (and whatever else you want) can be enabled by adding a method typically called <span class="math notranslate nohighlight">\(\color{blue}{\textbf{on_epoch_end}}\)</span> that will shuffle after some number of data points have been returned.</p>
</div>
<div class="section" id="tensorflow">
<h3>Tensorflow<a class="headerlink" href="#tensorflow" title="Permalink to this headline">¶</a></h3>
<p>But, since the Sequence object was recently deprecated in favor of Tensorflow’s data objects, we will proceed by setting up one of those. We only have to make a few adjustments to the above Readers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TFHologramReader</span><span class="p">:</span> 
    
    <span class="s1">&#39;Generates data for Keras/Tensorflow/Torch environments&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">path_data</span><span class="p">,</span> 
                 <span class="n">num_particles</span><span class="p">,</span> 
                 <span class="n">split</span><span class="p">,</span> 
                 <span class="n">output_cols</span><span class="p">,</span> 
                 <span class="n">subset</span><span class="p">,</span> 
                 <span class="n">maxnum_particles</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        
        <span class="s1">&#39;Initialization&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">open_dataset</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output_cols</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;hid&#39;</span><span class="p">]</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">hologram_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">hologram_number</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxnum_particles</span> <span class="o">=</span> <span class="n">maxnum_particles</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Return one row of data&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">hologram</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hologram_numbers</span><span class="p">):</span>
            <span class="c1"># Select one &quot;row&quot; from the dataset</span>
            <span class="n">x_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][</span><span class="n">hologram</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">maxnum_particles</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxnum_particles</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> 
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_cols</span><span class="p">)</span>
            <span class="p">))</span>
            <span class="n">particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;hid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hologram</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particles</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_cols</span><span class="p">):</span>
                    <span class="n">y_out</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

            <span class="k">yield</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">x_out</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">y_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that this Reader’s <span class="math notranslate nohighlight">\(\color{blue}{\textbf{__call__}}\)</span> is a generator, whereas before we used a method.</p>
<p>Calling and using the reader is the same as before. First, initialize an instance by setting the input variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf_data_generator</span> <span class="o">=</span> <span class="n">TFHologramReader</span><span class="p">(</span>
    <span class="n">path_data</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">output_cols</span><span class="p">,</span> <span class="n">subset</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we wrap Tensorflow’s Dataset object around the generator, using the <span class="math notranslate nohighlight">\(\color{blue}{\textbf{from_generator}}\)</span> method within the Dataset object, and setting the tensor types explictly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf_data_iterator</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span>
    <span class="n">tf_data_generator</span><span class="p">,</span> 
    <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Setting the batch size can be done by</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf_data_iterator</span> <span class="o">=</span> <span class="n">tf_data_iterator</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Shuffling is a little more complex. Since a generator is in play, a memory buffer of size buffer_size will be created and rows put into it. Then, batches are selected from it and returned. Note that there will be a delay in the begining as the buffer has to fill up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tf_data_iterator</span> <span class="o">=</span> <span class="n">tf_data_iterator</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To get true random sampling, the buffer size would need to be the size of the data set.</p>
<p>In practice, one should shuffle the hologram numbers list in the TFReader upon initialization since they are available, similar to what needed to be done when using the keras Sequence object. For the sake of illustration we use tensorflows method for shuffling.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tf_data_iterator</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(32, 600, 400) (32, 100, 4)
</pre></div>
</div>
</div>
</div>
<p>The number of workers can be set when training the model through the .fit() super-class (which contains an machinery for rolling out the Reader and feeding the batches it into the model):</p>
<p>Note that we could use any of these approaches with either ML language, though the torch and tensorflow versions are superior to the now-deparecated Sequence. Enabling multiprocessing with Tensorflow Data objects is rather tricky though, we just let the Keras methods handle that here. We will cover that another time!</p>
<p>Note that these special iterator objects contain many other features not covered here, so be sure to check out the documentation!</p>
<p>Tensorflow Dataset: <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset">https://www.tensorflow.org/api_docs/python/tf/data/Dataset</a></p>
<p>Torch Dataset: <a class="reference external" href="https://pytorch.org/docs/stable/data.html">https://pytorch.org/docs/stable/data.html</a></p>
<p>Feel free to email me (John Schreck, schreck&#64;ucar.edu) with any questions / mistakes / whatever!</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="home.html" title="previous page">Introduction</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By AIML @ NCAR<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>