
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>(2/26/21) A short primer on using Optuna and ECHO to interact with a sql database &#8212; Analytics and Integrative Machine Learning</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="(12/22/20) Helpful SLURM Commands" href="slurm.html" />
    <link rel="prev" title="Add a jupyter notebook as a blog" href="howto.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/NCAR-contemp-logo-blue.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Analytics and Integrative Machine Learning</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="home.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="howto.html">
   Add a jupyter notebook as a blog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="howto.html#license">
   License
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   (2/26/21) A short primer on using Optuna and ECHO to interact with a sql database
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="slurm.html">
   (12/22/20) Helpful SLURM Commands
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="memory.html">
   (12/22/20) Memory profiling python scripts with
   <em>
    memory_profiler
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="callbacks.html">
   (10/29/20) Callbacks: Utilities for interacting with ML training
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_loaders.html">
   (10/28/20) Data Loaders for ML Pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="generators.html">
   (10/27/20) Methods, iterables, and generators for reading files
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/optuna_mariadb.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/NCAR/aiml-utils/master?urlpath=lab/tree/blog/site/optuna_mariadb.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#we-have-access-to-a-mariadb-located-on-thunder">
   1. We have access to a MariaDB located on thunder
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optuna-does-not-have-much-to-say-with-regards-to-its-sql-support">
   2. Optuna does not have much to say with regards to its sql support.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-using-create-study-and-delete-study">
   3. Example: Using create_study and delete_study
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#for-more-checkout-this-tutorial-on-data-warehousing">
   4. For more, checkout this tutorial on data warehousing.
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="a-short-primer-on-using-optuna-and-echo-to-interact-with-a-sql-database">
<h1>(2/26/21) A short primer on using Optuna and ECHO to interact with a sql database<a class="headerlink" href="#a-short-primer-on-using-optuna-and-echo-to-interact-with-a-sql-database" title="Permalink to this headline">¶</a></h1>
<div class="section" id="we-have-access-to-a-mariadb-located-on-thunder">
<h2>1. We have access to a MariaDB located on <a class="reference external" href="https://www2.cisl.ucar.edu/resources/computational-systems/thunder-user-guide">thunder</a><a class="headerlink" href="#we-have-access-to-a-mariadb-located-on-thunder" title="Permalink to this headline">¶</a></h2>
<p>MariaDB: MySQL relational database management system.</p>
<p>The MariaDB server is accessible from an NCAR IP address, but you cannot login to MariaDB as root remotely. To interact with the database as root, you would need to ssh to thunder and from there you will be able to login to MariaDB as root to setup/manage the database. This will not affect the interaction between optuna and the database, but we will need root in order to manage the database (future).</p>
<p>In this blog, we have a database named “optuna”. For demonstrating purposes, we imagine that a user “icarus” exists. If you are at NCAR and are experimenting with mysql + optuna, you may email John Schreck about obtaining access. Ordinarily, to get onto thunder, you will use your NCAR password (same as for casper, cheyenne, etc).</p>
</div>
<div class="section" id="optuna-does-not-have-much-to-say-with-regards-to-its-sql-support">
<h2>2. Optuna does not have much to say with regards to its sql support.<a class="headerlink" href="#optuna-does-not-have-much-to-say-with-regards-to-its-sql-support" title="Permalink to this headline">¶</a></h2>
<p>In general, this interaction is low-level, while your interaction with optuna is much higher. To that end, the simplest way to go about managing your studies is to use the create_study and delete_study methods.</p>
<p>You may continue to use the sqlite “storage”, but be warned that once 1000 trials are saved to the named study, the performance will degrade quickly. This is especially apparent when running the hyperparameter importance metrics, which query the database and train a tree model on the fly.</p>
</div>
<div class="section" id="example-using-create-study-and-delete-study">
<h2>3. Example: Using create_study and delete_study<a class="headerlink" href="#example-using-create-study-and-delete-study" title="Permalink to this headline">¶</a></h2>
<p>First, lets see what tables are in the “optuna” database on thunder (from terminal):</p>
<p>(I shared an ssh key, hence not having to use Duo. Details at the bottom of this tutorial)</p>
<p>Next, lets list the study names user “schreck” has saved into optuna:</p>
<p>Now we create a new study named “example”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">optuna</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
    <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> 
    <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;mysql://icarus:password@thunder.ucar.edu/optuna&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Confirm that the study was actually created by repeating the command from earlier:</p>
<p>Next, in your hyperparameters.yml configuration file, we simply point to the database as follows under the optuna field:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">study_name</span><span class="p">:</span> <span class="s2">&quot;example&quot;</span>
<span class="n">storage</span><span class="p">:</span> <span class="s2">&quot;mysql://icarus:password@thunder.ucar.edu/optuna&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>You don’t have to worry about entering your sql password, it is already contained in the storage link! Since we are on an NCAR server, we also do not need to use Duo, although this will be changing in the near future. The forth-coming additional security will likely become problematic, but we will deal with that later.</p>
<p>Note that you don’t have to create a study beforehand if it does not exist, the optimize.py script that is used to launch a hyperparameter study, contained in the <a class="reference external" href="https://github.com/NCAR/aiml-utils/tree/master/aimlutils/echo">ECHO</a> package, will call create_study for you:</p>
<p>For now, when its time to delete a study from our optuna database, simply call the optuna method delete_study:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optuna</span><span class="o">.</span><span class="n">delete_study</span><span class="p">(</span>
    <span class="n">study_name</span><span class="o">=</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> 
    <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;mysql://icarus:password@thunder.ucar.edu/optuna&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us double check that it was actaully removed:</p>
<p>Ordinarily, you set reload = 0 in your hyperparameters.yml file when starting a new study. If the study name already exists, optimize.py/run.py will fail with an error message (I will not delete or overwrite things automatically. That job is left up to you).</p>
<p>When using the sqlite database solution, you simply delete that file. For sql support, the script will still complain at you, but a new parser option has been added that will facilitate the delete_study call:</p>
<p>E.g. you run:</p>
<p>And the study_name will be deleted from the storage container. Note that its gone forever, so be extra careful that this is what you intended.</p>
</div>
<div class="section" id="for-more-checkout-this-tutorial-on-data-warehousing">
<h2>4. For more, checkout <a class="reference external" href="https://www.guru99.com/data-warehousing-tutorial.html">this tutorial</a> on data warehousing.<a class="headerlink" href="#for-more-checkout-this-tutorial-on-data-warehousing" title="Permalink to this headline">¶</a></h2>
<p>Feel free to email me (John Schreck, schreck&#64;ucar.edu) with any questions / mistakes / whatever!</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="howto.html" title="previous page">Add a jupyter notebook as a blog</a>
    <a class='right-next' id="next-link" href="slurm.html" title="next page">(12/22/20) Helpful SLURM Commands</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By AIML @ NCAR<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>